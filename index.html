<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš–ï¸ AI ë²•ë¥  ìƒë‹´ SQL ìƒì„±ê¸°</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1.5rem;
            background-color: #f8f9fa;
            color: #212529;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            display: flex;
            flex: 1;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        h1, h2 {
            margin-top: 0;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }

        /* ë ˆì´ì•„ì›ƒ */
        .panel {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #left-panel {
            flex: 3;
            min-width: 400px;
        }
        #right-panel {
            flex: 2;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        #bottom-panel {
            width: 100%;
            margin-top: 1.5rem;
        }

        /* ì»¨íŠ¸ë¡¤ */
        button, input[type="file"]::file-selector-button {
            font-size: 0.9rem;
            padding: 0.5rem 0.8rem;
            border: 1px solid #0d6efd;
            border-radius: 5px;
            background-color: #0d6efd;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        button:hover, input[type="file"]::file-selector-button:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        button:disabled {
            background-color: #adb5bd;
            border-color: #adb5bd;
            cursor: not-allowed;
        }
        button.secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #5c636a;
            border-color: #565e64;
        }
        button.outline {
            background-color: white;
            color: #0d6efd;
        }
        button.outline:hover {
            background-color: #f8f9fa;
        }

        /* ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤íŠ¸ */
        .category-group {
            border: 1px solid #e9ecef;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        .category-group-header {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .category-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f5;
        }
        .category-item:last-child { border-bottom: none; }
        .category-item input[type="checkbox"] {
            width: 1.15rem;
            height: 1.15rem;
        }
        .category-item-label {
            width: 150px;
            font-weight: 500;
        }
        .file-status {
            flex: 1;
            font-size: 0.9rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-status.loaded {
            color: #d63384;
            font-weight: 600;
            border-style: solid;
            border-color: #e6a9c7;
            background-color: #fdf3f8;
        }

        /* íŒŒì¼ ì…ë ¥ ìˆ¨ê¸°ê¸° */
        input[type="file"] {
            display: none;
        }

        /* ë¡œê·¸ */
        #log-output {
            flex: 1;
            width: 100%;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.85rem;
            color: #343a40;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 0.5rem;
            box-sizing: border-box;
            background-color: #f8f9fa;
            min-height: 200px;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            animation: slideIn 0.3s;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .modal-body {
            padding-top: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-body pre, .modal-body textarea {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
        }
        .modal-body textarea {
            width: 100%;
            box-sizing: border-box;
            min-height: 60vh;
            resize: vertical;
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: black;
        }

        /* íŠ¸ë¦¬ ë·° */
        .tree-view details {
            margin-left: 20px;
            border-left: 1px dashed #adb5bd;
            margin-top: 5px;
        }
        .tree-view summary {
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            background-color: #f1f3f5;
            font-weight: bold;
        }
        .tree-view summary:hover { background-color: #e9ecef; }
        .tree-view .answer {
            margin-left: 15px;
            padding: 5px;
        }
        .tree-view .answer code {
            font-weight: bold;
            color: #0b5ed7;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

    </style>
</head>
<body>

    <header>
        <h1>âš–ï¸ AI ë²•ë¥  ìƒë‹´ SQL ìƒì„±ê¸° (Web Ver.)</h1>
    </header>

    <main>
        <div id="left-panel" class="panel">
            <h2>1. ì¹´í…Œê³ ë¦¬ ë° JSON íŒŒì¼ ì„ íƒ</h2>

            <div style="background-color: #fff3cd; border: 1px solid #ffe69c; color: #664d03; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                <strong>ì°¸ê³ :</strong> ì›¹ ë²„ì „ì€ ë°±ì—”ë“œ ì„œë²„ ì—†ì´ ë™ì‘í•˜ë¯€ë¡œ,
                <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/CORS" target="_blank">CORS ì •ì±…</a>
                ì œí•œìœ¼ë¡œ ì¸í•´ ë²ˆì—­ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. SQLì€ ê¸°ë³¸ ì–¸ì–´('ko')ë¡œë§Œ ìƒì„±ë©ë‹ˆë‹¤.
            </div>

            <div>
                <button id="toggle-all-checkboxes">ì „ì²´ ì„ íƒ/í•´ì œ</button>
                <button id="show-schema-button" class="secondary outline" style="float: right;">ğŸ“œ ìŠ¤í‚¤ë§ˆ ë³´ê¸°</button>
            </div>

            <div id="category-list" style="margin-top: 1rem;">
                </div>
        </div>

        <div id="right-panel" class="panel">
            <h2>2. ì²˜ë¦¬ ë¡œê·¸</h2>
            <textarea id="log-output" readonly></textarea>
        </div>
    </main>

    <footer id="bottom-panel" class="panel">
        <h2>3. SQL ìƒì„± ë° ë‹¤ìš´ë¡œë“œ</h2>
        <button id="generate-sql-button" style="width: 200px; height: 50px; font-size: 1.2rem;">ğŸš€ SQL ìƒì„±í•˜ê¸°</button>
        <button id="download-sql-button" class="secondary" style="width: 200px; height: 50px; font-size: 1.2rem;" disabled>ğŸ“„ SQL ë‹¤ìš´ë¡œë“œ</button>
    </footer>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">ëª¨ë‹¬ ì œëª©</h2>
                <span id="modal-close" class="close-button">&times;</span>
            </div>
            <div id="modal-body" class="modal-body">
                </div>
        </div>
    </div>

    <input type="file" id="file-picker" accept=".json">


    <script>
        // --- 0. ìƒìˆ˜ ì •ì˜ (default_values.py + schema.sql) ---
        // 'default_values.py'ì˜ CATEGORIESë¥¼ JS ê°ì²´ë¡œ ë³€í™˜
        const CATEGORIES = {
            '1': {'id': 100, 'code': 'INSURANCE', 'name': 'ë³´í—˜ê¸ˆ', 'subs': {
                '1': {'id': 101, 'code': 'INS_SUICIDE', 'name': 'ìì‚´ë³´í—˜ê¸ˆ'}, '2': {'id': 102, 'code': 'INS_ACCIDENT_DEATH', 'name': 'ìƒí•´ì‚¬ë§ë³´í—˜ê¸ˆ'},
                '3': {'id': 103, 'code': 'INS_DISPUTE', 'name': 'ë³´í—˜ê¸ˆë¶„ìŸ'}, '4': {'id': 104, 'code': 'INS_FRAUD', 'name': 'ë³´í—˜ì‚¬ê¸°'},
                '5': {'id': 105, 'code': 'INS_FIRE', 'name': 'í™”ì¬ë³´í—˜'}, }},
            '2': {'id': 200, 'code': 'TRAFFIC_ACCIDENT', 'name': 'êµí†µì‚¬ê³ ', 'subs': {
                '1': {'id': 201, 'code': 'TRF_DRIVER_INS', 'name': 'ìš´ì „ìë³´í—˜'}, '2': {'id': 202, 'code': 'TRF_12_NEGLIGENCE', 'name': '12ëŒ€ ì¤‘ê³¼ì‹¤'},
                '3': {'id': 203, 'code': 'TRF_INJURY', 'name': 'ì—…ë¬´ìƒê³¼ì‹¤ì¹˜ìƒ'}, '4': {'id': 204, 'code': 'TRF_MOTORCYCLE', 'name': 'ì´ë¥œì°¨ì‚¬ê³ '}, }},
            '3': {'id': 300, 'code': 'CRIMINAL', 'name': 'í˜•ì‚¬', 'subs': {
                '1': {'id': 301, 'code': 'CRM_ASSAULT', 'name': 'í­í–‰/ìƒí•´'}, '2': {'id': 302, 'code': 'CRM_COMM_OBSCENITY', 'name': 'í†µë§¤ìŒ'},
                '3': {'id': 303, 'code': 'CRM_FRAUD', 'name': 'ì‚¬ê¸°'}, '4': {'id': 304, 'code': 'CRM_DEFAMATION', 'name': 'ëª¨ìš•/ëª…ì˜ˆí›¼ì†'},
                '5': {'id': 305, 'code': 'CRM_SEXUAL', 'name': 'ì„±ë²”ì£„'}, }}
        };

        // 'default_values.py'ì˜ SUPPORTED_LANGUAGES (ì°¸ê³ ìš©)
        const SUPPORTED_LANGUAGES = {
            "ko": "í•œêµ­ì–´", "en": "ì˜ì–´", "zh": "ì¤‘êµ­ì–´", "es": "ìŠ¤í˜ì¸ì–´", "ja": "ì¼ë³¸ì–´",
            "vi": "ë² íŠ¸ë‚¨ì–´", "th": "íƒœêµ­ì–´", "ms": "ë§ë ˆì´ì–´", "id": "ì¸ë„ë„¤ì‹œì•„ì–´", "fil": "í•„ë¦¬í•€ì–´", "ru": "ëŸ¬ì‹œì•„ì–´"
        };

        const BASE_LANGUAGE = 'ko';
        const END_OF_QUESTION_CODE = 'END';

        // 'schema.sql' ë˜ëŠ” 'default_values.py'ì˜ DEFAULT_SCHEMA_SQL
        const DEFAULT_SCHEMA_SQL = `
CREATE SCHEMA IF NOT EXISTS consultation;

-- 1. ë©”ì¸ ì¹´í…Œê³ ë¦¬
CREATE TABLE consultation.categories (
    id INT PRIMARY KEY,
    code VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 1-1. ë©”ì¸ ì¹´í…Œê³ ë¦¬ ë‹¤êµ­ì–´
CREATE TABLE consultation.category_translations (
    id SERIAL PRIMARY KEY,
    category_id INT NOT NULL REFERENCES consultation.categories(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (category_id, language)
);

-- 2. ì„œë¸Œ ì¹´í…Œê³ ë¦¬
CREATE TABLE consultation.sub_categories (
    id INT PRIMARY KEY,
    category_id INT NOT NULL REFERENCES consultation.categories(id) ON DELETE CASCADE,
    code VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2-1. ì„œë¸Œ ì¹´í…Œê³ ë¦¬ ë‹¤êµ­ì–´
CREATE TABLE consultation.sub_category_translations (
    id SERIAL PRIMARY KEY,
    sub_category_id INT NOT NULL REFERENCES consultation.sub_categories(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (sub_category_id, language)
);

-- 3. ì‚¬ì „ ì§ˆë¬¸
CREATE TABLE consultation.pre_questions (
    id SERIAL PRIMARY KEY,
    sub_category_id INT NOT NULL REFERENCES consultation.sub_categories(id) ON DELETE CASCADE,
    code VARCHAR(100) UNIQUE NOT NULL, -- 'SQ001'ê³¼ ê°™ì€ ì½”ë“œ
    description TEXT,
    step INT NOT NULL,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3-1. ì‚¬ì „ ì§ˆë¬¸ ë‹¤êµ­ì–´
CREATE TABLE consultation.pre_question_translations (
    id SERIAL PRIMARY KEY,
    pre_question_id INT NOT NULL REFERENCES consultation.pre_questions(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    question_text TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (pre_question_id, language)
);

-- 4. ì‚¬ì „ ì§ˆë¬¸ ì„ íƒì§€
CREATE TABLE consultation.pre_question_options (
    id SERIAL PRIMARY KEY,
    pre_question_id INT NOT NULL REFERENCES consultation.pre_questions(id) ON DELETE CASCADE,
    code VARCHAR(100) UNIQUE NOT NULL, -- 'SQ001_O001'ê³¼ ê°™ì€ ì½”ë“œ
    next_question_code VARCHAR(100), -- ë¶„ê¸° ë¡œì§
    description TEXT,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4-1. ì‚¬ì „ ì§ˆë¬¸ ì„ íƒì§€ ë‹¤êµ­ì–´
CREATE TABLE consultation.pre_question_option_translations (
    id SERIAL PRIMARY KEY,
    pre_question_option_id INT NOT NULL REFERENCES consultation.pre_question_options(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    option_text VARCHAR(255) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (pre_question_option_id, language)
);
        `.trim();

        // --- 1. ì „ì—­ ìƒíƒœ ë³€ìˆ˜ ---
        /** @type {Object<string, {file: File, data: Object}>} */
        let loadedFiles = {};
        /** @type {string|null} */
        let generatedSqlContent = null;
        /** @type {HTMLInputElement} */
        let currentFilePickerSubCatId = null;

        // --- 2. DOM ì°¸ì¡° ---
        const categoryListDiv = document.getElementById('category-list');
        const logOutput = document.getElementById('log-output');
        const generateSqlButton = document.getElementById('generate-sql-button');
        const downloadSqlButton = document.getElementById('download-sql-button');
        const toggleAllCheckboxesButton = document.getElementById('toggle-all-checkboxes');

        // íŒŒì¼ í”¼ì»¤
        const filePicker = document.getElementById('file-picker');

        // ëª¨ë‹¬
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const showSchemaButton = document.getElementById('show-schema-button');

        // --- 3. í—¬í¼ í•¨ìˆ˜ (Python ë¡œì§ ì´ì‹) ---

        /**
         * ë¡œê·¸ë¥¼ í™”ë©´ì— ì¶œë ¥
         * @param {string} message
         */
        function logMessage(message) {
            console.log(message);
            logOutput.value += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
        }

        /**
         * í…ìŠ¤íŠ¸ë¥¼ ì •ë¦¬ (SQL ì¸ì ì…˜ ë°©ì§€)
         * @param {string} text
         * @returns {string}
         */
        function clean_text(text) {
            if (!text) return "";
            return text.replace(/\n/g, ' ')
                       .replace(/\r/g, '')
                       .trim()
                       .replace(/'/g, "''"); // 'ë¥¼ ''ë¡œ ì´ìŠ¤ì¼€ì´í”„
        }

        /**
         * ë”ë¯¸ JSON ë°ì´í„° ìƒì„± (Python 'generate_dummy_json' ì´ì‹)
         * @param {string} sub_cat_name
         * @returns {Object}
         */
        function generate_dummy_json(sub_cat_name) {
            const dummy_indicator = "(ë”ë¯¸ ë°ì´í„° ì…ë‹ˆë‹¤)";
            logMessage(`[ì•Œë¦¼] ë”ë¯¸ ë°ì´í„° ìƒì„±: ${sub_cat_name}`);
            return {
                "id": `dummy-${sub_cat_name}`, "title": sub_cat_name,
                "fields": [
                    {"id": "q1_id", "ref": "q1_ref", "title": `[${sub_cat_name}] ì‚¬ê±´ì˜ í”¼í•´ìì´ì‹­ë‹ˆê¹Œ? ${dummy_indicator}`,
                    "properties": {"choices": [{"id": "q1_yes_id", "ref": "q1_yes_ref", "label": "ì˜ˆ (í”¼í•´ì)"}, {"id": "q1_no_id", "ref": "q1_no_ref", "label": "ì•„ë‹ˆì˜¤ (ê°€í•´ì)"}]}},
                    {"id": "q2_victim_id", "ref": "q2_victim_ref", "title": `(í”¼í•´ì) í˜„ì¬ ì¦ê±° ìë£Œê°€ ì¤€ë¹„ë˜ì…¨ë‚˜ìš”? ${dummy_indicator}`,
                    "properties": {"choices": [{"id": "q2_yes_id", "ref": "q2_yes_ref", "label": "ì˜ˆ"}, {"id": "q2_no_id", "ref": "q2_no_ref", "label": "ì•„ë‹ˆì˜¤"}]}},
                    {"id": "q3_perp_id", "ref": "q3_perp_ref", "title": `(ê°€í•´ì) í˜ì˜ë¥¼ ì¸ì •í•˜ì‹­ë‹ˆê¹Œ? ${dummy_indicator}`,
                    "properties": {"choices": [{"id": "q3_yes_id", "ref": "q3_yes_ref", "label": "ì˜ˆ"}, {"id": "q3_no_id", "ref": "q3_no_ref", "label": "ì•„ë‹ˆì˜¤"}]}}],
                "logic": [
                    {"ref": "q1_ref", "actions": [
                        {"condition": {"op": "is", "vars": [{}, {"type": "choice", "value": "q1_yes_ref"}]}, "details": {"to": {"type": "field", "value": "q2_victim_ref"}}},
                        {"condition": {"op": "is", "vars": [{}, {"type": "choice", "value": "q1_no_ref"}]}, "details": {"to": {"type": "field", "value": "q3_perp_ref"}}}]},
                    {"ref": "q2_victim_ref", "actions": [{"condition": {"op": "always", "vars": []}, "details": {"to": {"type": "thankyou", "value": "default_tys"}}}]},
                    {"ref": "q3_perp_ref", "actions": [{"condition": {"op": "always", "vars": []}, "details": {"to": {"type": "thankyou", "value": "default_tys"}}}]}]
            };
        }

        /**
         * JSON ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ íŠ¸ë¦¬ êµ¬ì¡° ìƒì„± (Python 'build_tree_data' ì´ì‹)
         * @param {Object} json_data
         * @param {number} sub_cat_id
         * @returns {Object}
         */
        function build_tree_data(json_data, sub_cat_id) {
            const tree = {};
            const ref_to_q_code = {};
            const fields = json_data.fields || [];

            fields.forEach((field, i) => {
                const q_code = `${sub_cat_id}_Q${String(i + 1).padStart(3, '0')}`;
                ref_to_q_code[field.ref] = q_code;
            });

            const logic_map = {};
            (json_data.logic || []).forEach(logic => {
                const current_q_ref = logic.ref;
                (logic.actions || []).forEach(action => {
                    let next_q_ref = action.details.to.value;
                    if (action.details.to.type === 'thankyou') next_q_ref = END_OF_QUESTION_CODE;
                    const condition = action.condition;
                    if (condition.op === 'is') {
                        logic_map[[current_q_ref, condition.vars[1].value]] = next_q_ref;
                    } else if (condition.op === 'always') {
                        logic_map[[current_q_ref, 'always']] = next_q_ref;
                    }
                });
            });

            fields.forEach((field, i) => {
                const q_ref = field.ref;
                const q_code = ref_to_q_code[q_ref];
                const q_text = clean_text(field.title);
                const answers_data = [];
                const choices = (field.properties || {}).choices || [];

                if (choices.length === 0) {
                    const next_q_ref = logic_map[[q_ref, 'always']];
                    const next_q = (next_q_ref === END_OF_QUESTION_CODE) ? END_OF_QUESTION_CODE : (ref_to_q_code[next_q_ref] || "???");
                    answers_data.push({"text": "(ì£¼ê´€ì‹ ë‹µë³€)", "next_q": next_q});
                } else {
                    choices.forEach(choice => {
                        const c_ref = choice.ref;
                        const c_text = clean_text(choice.label);
                        let next_q_ref = logic_map[[q_ref, c_ref]];
                        if (!next_q_ref) next_q_ref = logic_map[[q_ref, 'always']];
                        const next_q = (next_q_ref === END_OF_QUESTION_CODE) ? END_OF_QUESTION_CODE : (ref_to_q_code[next_q_ref] || "???");
                        answers_data.push({"text": c_text, "next_q": next_q});
                    });
                }
                tree[q_code] = {"text": q_text, "answers": answers_data, "ref": q_ref};
            });
            return { tree_data: tree, ref_map: ref_to_q_code };
        }

        /**
         * íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ HTMLë¡œ ë Œë”ë§ (Python 'build_tree_view_controls' ì´ì‹)
         * @param {Object} tree_data
         * @param {string} start_question_ref
         * @param {Object} ref_to_q_code
         * @returns {string}
         */
        function build_tree_view_html(tree_data, start_question_ref, ref_to_q_code) {
            if (!tree_data || !start_question_ref) {
                return `<p style="color: red;">í‘œì‹œí•  ì§ˆë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
            const start_q_code = ref_to_q_code[start_question_ref];
            if (!start_q_code) {
                return `<p style="color: red;">ì‹œì‘ ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }

            let html = '<div class="tree-view">';
            const panels_dict = {};

            for (const [q_code, question] of Object.entries(tree_data)) {
                let answers_html = '';
                question.answers.forEach(answer => {
                    const next_q_str = (answer.next_q !== END_OF_QUESTION_CODE) ? `â¡ï¸ <code>${answer.next_q}</code>` : "â¡ï¸ <code>ì¢…ë£Œ</code>";
                    answers_html += `<div class="answer"><i>${answer.text}</i> ${next_q_str}</div>`;
                });
                panels_dict[q_code] = `
                    <details>
                        <summary>[${q_code}] ${question.text}</summary>
                        ${answers_html}
                    </details>
                `;
            }

            const processed_codes = new Set();
            const queue = [start_q_code];
            while (queue.length > 0) {
                const current_code = queue.shift();
                if (!panels_dict[current_code] || processed_codes.has(current_code)) continue;

                html += panels_dict[current_code];
                processed_codes.add(current_code);

                const question = tree_data[current_code];
                question.answers.forEach(answer => {
                    const next_q = answer.next_q;
                    if (next_q !== END_OF_QUESTION_CODE && next_q !== "???" && !processed_codes.has(next_q)) {
                        if (!queue.includes(next_q)) queue.push(next_q);
                    }
                });
            }

            html += '</div>';
            return html;
        }

        /**
         * Typeform JSONì„ SQLë¡œ íŒŒì‹± (Python 'parse_typeform_to_sql' ì´ì‹)
         * @param {Object} json_data
         * @param {Object} sub_cat
         * @returns {string[]}
         */
        function parse_typeform_to_sql(json_data, sub_cat) {
            const sql_commands = [];
            try {
                logMessage(`  > 3. ë¶„ê¸° ë¡œì§(Logic) íŒŒì‹± ì¤‘...`);
                const logic_map = {};
                (json_data.logic || []).forEach(logic => {
                    const current_q_ref = logic.ref;
                    (logic.actions || []).forEach(action => {
                        let next_q_ref = action.details.to.value;
                        if (action.details.to.type === 'thankyou') next_q_ref = END_OF_QUESTION_CODE;

                        const condition = action.condition;
                        if (condition.op === 'is') {
                            logic_map[[current_q_ref, condition.vars[1].value]] = next_q_ref;
                        } else if (condition.op === 'always') {
                            logic_map[[current_q_ref, 'always']] = next_q_ref;
                        }
                    });
                });

                logMessage(`  > 4. ì§ˆë¬¸/ë‹µë³€ ì½”ë“œ ë§¤í•‘ ì¤‘...`);
                const ref_to_q_code = {};
                const ref_to_opt_code = {};
                const sub_cat_prefix = sub_cat.id;
                const fields = json_data.fields || [];

                fields.forEach((field, i) => {
                    const q_code = `${sub_cat_prefix}_Q${String(i + 1).padStart(3, '0')}`;
                    ref_to_q_code[field.ref] = q_code;

                    ((field.properties || {}).choices || []).forEach((choice, j) => {
                        const opt_code = `${q_code}_O${String(j + 1).padStart(3, '0')}`;
                        ref_to_opt_code[choice.ref] = opt_code;
                    });
                });

                logMessage(`  > 5. ì‚¬ì „ ì§ˆë¬¸(Pre Questions) SQL ìƒì„± ì‹œì‘...`);
                fields.forEach((field, i) => {
                    const field_ref = field.ref;
                    const q_code = ref_to_q_code[field_ref];
                    const q_title_ko = clean_text(field.title);
                    const step = i + 1;
                    logMessage(`    > ì§ˆë¬¸ ${step} (${q_code}): ${q_title_ko} ìƒì„± ì¤‘`);

                    sql_commands.push(`\n-- ì§ˆë¬¸ ${step}: ${q_title_ko} (Code: ${q_code}) --`);
                    sql_commands.push(
                        `INSERT INTO consultation.pre_questions (sub_category_id, code, description, step, display_order, is_active, created_at, updated_at)\n` +
                        `VALUES (${sub_cat.id}, '${q_code}', '${q_title_ko}', ${step}, ${i+1}, true, NOW(), NOW());`
                    );

                    // ë²ˆì—­ ë¡œì§ ì œê±° - ê¸°ë³¸ ì–¸ì–´('ko')ë§Œ ì¶”ê°€
                    sql_commands.push(
                        `INSERT INTO consultation.pre_question_translations (pre_question_id, language, question_text, created_at, updated_at)\n` +
                        `VALUES ((SELECT id FROM consultation.pre_questions WHERE code = '${q_code}'), '${BASE_LANGUAGE}', '${q_title_ko}', NOW(), NOW());`
                    );

                    const choices = (field.properties || {}).choices || [];
                    if (choices.length === 0) {
                        // ì£¼ê´€ì‹ (ì„ íƒì§€ ì—†ìŒ)
                        const next_q_ref = logic_map[[field_ref, 'always']];
                        let next_q_code_sql = "null";
                        if (next_q_ref === END_OF_QUESTION_CODE) {
                            next_q_code_sql = `'${END_OF_QUESTION_CODE}'`;
                        } else if (next_q_ref) {
                            next_q_code_sql = `'${ref_to_q_code[next_q_ref] || ''}'`;
                        }

                        const opt_code = `${q_code}_O001`;
                        sql_commands.push(
                            `INSERT INTO consultation.pre_question_options (pre_question_id, code, description, display_order, is_active, next_question_code, created_at, updated_at)\n` +
                            `VALUES ((SELECT id FROM consultation.pre_questions WHERE code = '${q_code}'), '${opt_code}', 'ì£¼ê´€ì‹ ë‹µë³€', 1, true, ${next_q_code_sql}, NOW(), NOW());`
                        );

                        // ê¸°ë³¸ ì–¸ì–´('ko') ë²ˆì—­ ì¶”ê°€
                        sql_commands.push(
                            `INSERT INTO consultation.pre_question_option_translations (pre_question_option_id, language, option_text, created_at, updated_at)\n` +
                            `VALUES ((SELECT id FROM consultation.pre_question_options WHERE code = '${opt_code}'), '${BASE_LANGUAGE}', 'ë‹¤ìŒ', NOW(), NOW());`
                        );

                    } else {
                        // ê°ê´€ì‹ (ì„ íƒì§€ ìˆìŒ)
                        choices.forEach((choice, j) => {
                            const choice_ref = choice.ref;
                            const opt_code = ref_to_opt_code[choice_ref];
                            const opt_label_ko = clean_text(choice.label);

                            let next_q_ref = logic_map[[field_ref, choice_ref]];
                            if (!next_q_ref) next_q_ref = logic_map[[field_ref, 'always']];

                            let next_q_code_sql = "null";
                            if (next_q_ref === END_OF_QUESTION_CODE) {
                                next_q_code_sql = `'${END_OF_QUESTION_CODE}'`;
                            } else if (next_q_ref) {
                                next_q_code_sql = `'${ref_to_q_code[next_q_ref] || ''}'`;
                            }

                            sql_commands.push(
                                `INSERT INTO consultation.pre_question_options (pre_question_id, code, description, display_order, is_active, next_question_code, created_at, updated_at)\n` +
                                `VALUES ((SELECT id FROM consultation.pre_questions WHERE code = '${q_code}'), '${opt_code}', '${opt_label_ko}', ${j+1}, true, ${next_q_code_sql}, NOW(), NOW());`
                            );

                            // ê¸°ë³¸ ì–¸ì–´('ko') ë²ˆì—­ ì¶”ê°€
                            sql_commands.push(
                                `INSERT INTO consultation.pre_question_option_translations (pre_question_option_id, language, option_text, created_at, updated_at)\n` +
                                `VALUES ((SELECT id FROM consultation.pre_question_options WHERE code = '${opt_code}'), '${BASE_LANGUAGE}', '${opt_label_ko}', NOW(), NOW());`
                            );
                        });
                    }
                });

                logMessage(`  > 6. ëª¨ë“  SQL ì»¤ë§¨ë“œ ìƒì„± ì™„ë£Œ.`);
                return sql_commands;

            } catch (e) {
                const error_msg = `SQL íŒŒì‹± ì¤‘ ì˜¤ë¥˜: ${e.message} (at ${e.stack.split('\n')[1].trim()})`;
                logMessage(`[ì˜¤ë¥˜] ${error_msg}`);
                throw new Error(error_msg);
            }
        }

        // --- 4. ë©”ì¸ ë¡œì§ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬) ---

        /**
         * ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”: ì¹´í…Œê³ ë¦¬ ëª©ë¡ ìƒì„±
         */
        function initialize() {
            logMessage("ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì¤‘...");
            let html = "";
            for (const [main_key, main_cat] of Object.entries(CATEGORIES)) {
                html += `<div class="category-group">`;
                html += `<div class="category-group-header">${main_cat.name}</div>`;

                for (const [sub_key, sub_cat] of Object.entries(main_cat.subs)) {
                    const sub_cat_id = sub_cat.id;
                    html += `
                        <div class="category-item" data-sub-cat-id="${sub_cat_id}">
                            <input type="checkbox" id="chk-${sub_cat_id}" data-sub-cat-id="${sub_cat_id}">
                            <label for="chk-${sub_cat_id}" class="category-item-label">${sub_cat.name}</label>

                            <span class="file-status" id="status-${sub_cat_id}">ì„ íƒëœ JSON íŒŒì¼ ì—†ìŒ...</span>

                            <button class="view-structure-button outline" data-sub-cat-id="${sub_cat_id}" data-sub-cat-name="${sub_cat.name}">êµ¬ì¡° ë³´ê¸°</button>
                            <button class="load-file-button" data-sub-cat-id="${sub_cat_id}">JSON ë¡œë“œ</button>
                        </div>
                    `;
                }
                html += `</div>`;
            }
            categoryListDiv.innerHTML = html;
            logMessage("ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ.");
        }

        /**
         * íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬ (ì´ë²¤íŠ¸ ìœ„ì„)
         * @param {Event} e
         */
        function handleCategoryClick(e) {
            const target = e.target;

            // "JSON ë¡œë“œ" ë²„íŠ¼ í´ë¦­
            if (target.classList.contains('load-file-button')) {
                const subCatId = target.dataset.subCatId;
                currentFilePickerSubCatId = subCatId; // í˜„ì¬ ì‘ì—…ì¤‘ì¸ ID ì €ì¥
                filePicker.click(); // ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ í´ë¦­
            }

            // "êµ¬ì¡° ë³´ê¸°" ë²„íŠ¼ í´ë¦­
            if (target.classList.contains('view-structure-button')) {
                const subCatId = target.dataset.subCatId;
                const subCatName = target.dataset.subCatName;
                showTreeModal(subCatId, subCatName);
            }
        }

        /**
         * ì‹¤ì œ íŒŒì¼ì´ ì„ íƒë˜ì—ˆì„ ë•Œì˜ í•¸ë“¤ëŸ¬
         * @param {Event} e
         */
        function handleFileSelect(e) {
            if (!currentFilePickerSubCatId || e.target.files.length === 0) {
                logMessage("íŒŒì¼ ì„ íƒ ì·¨ì†Œë¨.");
                currentFilePickerSubCatId = null;
                return;
            }

            const file = e.target.files[0];
            const subCatId = currentFilePickerSubCatId;
            currentFilePickerSubCatId = null; // ë¦¬ì…‹

            if (!file.type.includes('json')) {
                logMessage(`[ì˜¤ë¥˜] '${file.name}'ì€(ëŠ”) JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.`);
                alert("JSON íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const json_data = JSON.parse(event.target.result);
                    loadedFiles[subCatId] = { file: file, data: json_data };

                    // UI ì—…ë°ì´íŠ¸
                    const statusSpan = document.getElementById(`status-${subCatId}`);
                    statusSpan.textContent = `âœ… ${file.name}`;
                    statusSpan.title = file.name;
                    statusSpan.classList.add('loaded');

                    logMessage(`íŒŒì¼ ë¡œë“œ ì„±ê³µ (${subCatId}): ${file.name}`);
                } catch (err) {
                    logMessage(`[ì˜¤ë¥˜] '${file.name}' íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${err.message}`);
                    alert(`íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ${err.message}`);
                }
            };

            reader.onerror = () => {
                logMessage(`[ì˜¤ë¥˜] '${file.name}' íŒŒì¼ ì½ê¸° ì‹¤íŒ¨.`);
                alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            };

            reader.readAsText(file, 'UTF-8');

            // ë™ì¼í•œ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ valueë¥¼ ë¦¬ì…‹
            e.target.value = null;
        }

        /**
         * "ì „ì²´ ì„ íƒ/í•´ì œ" í•¸ë“¤ëŸ¬
         */
        function handleToggleAllCheckboxes() {
            const checkboxes = categoryListDiv.querySelectorAll('input[type="checkbox"]');
            // ì²« ë²ˆì§¸ ì²´í¬ë°•ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ìƒíƒœ ê²°ì •
            const isChecked = checkboxes.length > 0 ? !checkboxes[0].checked : false;
            checkboxes.forEach(chk => chk.checked = isChecked);
            logMessage(isChecked ? "ëª¨ë“  í•­ëª© ì„ íƒë¨." : "ëª¨ë“  í•­ëª© í•´ì œë¨.");
        }

        /**
         * "ìŠ¤í‚¤ë§ˆ ë³´ê¸°" í•¸ë“¤ëŸ¬
         */
        function showSchemaModal() {
            modalTitle.textContent = "ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (schema.sql)";
            modalBody.innerHTML = `<textarea readonly>${DEFAULT_SCHEMA_SQL}</textarea>`;
            modal.style.display = "block";
        }

        /**
         * "êµ¬ì¡° ë³´ê¸°" í•¸ë“¤ëŸ¬
         * @param {string} subCatId
         * @param {string} subCatName
         */
        function showTreeModal(subCatId, subCatName) {
            logMessage(`'${subCatName}'ì˜ êµ¬ì¡° ë³´ê¸° ë¡œë”© ì¤‘...`);
            let json_data = null;
            let html_content = "";

            if (loadedFiles[subCatId]) {
                json_data = loadedFiles[subCatId].data;
                logMessage(` > ë¡œë“œëœ '${loadedFiles[subCatId].file.name}' íŒŒì¼ ì‚¬ìš©.`);
            } else {
                json_data = generate_dummy_json(subCatName);
                logMessage(` > ë¡œë“œëœ íŒŒì¼ ì—†ìŒ. ë”ë¯¸ ë°ì´í„°ë¡œ êµ¬ì¡° ìƒì„±.`);
            }

            if (!json_data || !json_data.fields || json_data.fields.length === 0) {
                 html_content = `<p style="color: red;">'${subCatName}'ì— ìœ íš¨í•œ ì§ˆë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                 logMessage(`[ì˜¤ë¥˜] '${subCatName}'ì— ìœ íš¨í•œ ì§ˆë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
            } else {
                try {
                    const { tree_data, ref_map } = build_tree_data(json_data, parseInt(subCatId));
                    const start_ref = json_data.fields[0].ref;
                    html_content = build_tree_view_html(tree_data, start_ref, ref_map);
                    logMessage(`'${subCatName}' êµ¬ì¡° ë°ì´í„° ìƒì„± ì™„ë£Œ.`);
                } catch (build_err) {
                    html_content = `<p style="color: red;">íŠ¸ë¦¬ ë·° ìƒì„± ì‹¤íŒ¨:\n${build_err.message}</p>`;
                    logMessage(`[ì˜¤ë¥˜] '${subCatName}' íŠ¸ë¦¬ ë·° ìƒì„± ì‹¤íŒ¨: ${build_err.message}`);
                }
            }

            modalTitle.textContent = `${subCatName} - ì§ˆë¬¸ êµ¬ì¡°`;
            modalBody.innerHTML = html_content;
            modal.style.display = "block";
        }

        /**
         * ëª¨ë‹¬ ë‹«ê¸°
         */
        function closeModal() {
            modal.style.display = "none";
            modalBody.innerHTML = ""; // ë‚´ìš© ë¹„ìš°ê¸°
        }

        /**
         * "SQL ìƒì„±í•˜ê¸°" í•¸ë“¤ëŸ¬ (Python 'run_generation_thread' ì´ì‹)
         */
        function handleGenerateSql() {
            logMessage("SQL ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...");
            logOutput.value = "ì²˜ë¦¬ ë¡œê·¸:\n"; // ë¡œê·¸ ì´ˆê¸°í™”
            logMessage("SQL ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤...");

            generateSqlButton.disabled = true;
            generateSqlButton.textContent = "ìƒì„± ì¤‘...";
            downloadSqlButton.disabled = true;
            generatedSqlContent = null;

            let has_error = false;
            const processed_main_cats = new Set();
            const processed_sub_cats = new Set();

            const main_cat_sql = ["-- ğŸ“œ 1. ë©”ì¸ ì¹´í…Œê³ ë¦¬ (Main Category) --"];
            const sub_cat_sql = ["-- ğŸ“œ 2. ì„œë¸Œ ì¹´í…Œê³ ë¦¬ (Sub Category) --"];
            const pre_question_sql = ["-- ğŸ“œ 3. ì‚¬ì „ ì§ˆë¬¸ (Pre Questions) --"];

            const selected_language = BASE_LANGUAGE; // ì›¹ ë²„ì „ì€ 'ko'ë§Œ ì§€ì›

            try {
                const jobs_to_process = [];
                logMessage("1. ì‘ì—… ëª©ë¡ ìˆ˜ì§‘ ì¤‘...");

                const checkboxes = categoryListDiv.querySelectorAll('input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                     logMessage("ì„ íƒëœ ì„œë¸Œ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.");
                     throw new Error("ì²˜ë¦¬í•  í•­ëª©ì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
                }

                checkboxes.forEach(chk => {
                    const sub_cat_id = chk.dataset.subCatId;
                    // ë¶€ëª¨-ìì‹ ê´€ê³„ ì°¾ê¸°
                    let main_cat_data = null;
                    let sub_cat_data = null;
                    for (const main_cat of Object.values(CATEGORIES)) {
                        for (const sub_cat of Object.values(main_cat.subs)) {
                            if (sub_cat.id == sub_cat_id) {
                                main_cat_data = main_cat;
                                sub_cat_data = sub_cat;
                                break;
                            }
                        }
                        if (sub_cat_data) break;
                    }

                    if (!main_cat_data || !sub_cat_data) {
                        logMessage(`[ê²½ê³ ] ID ${sub_cat_id}ì— í•´ë‹¹í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ì •ì˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤.`);
                        return;
                    }

                    let json_data = null;
                    if (loadedFiles[sub_cat_id]) {
                        json_data = loadedFiles[sub_cat_id].data;
                    } else {
                        logMessage(` > '${sub_cat_data.name}' íŒŒì¼ ì—†ìŒ. ë”ë¯¸ ë°ì´í„°ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.`);
                        json_data = generate_dummy_json(sub_cat_data.name);
                    }

                    const json_title = clean_text(json_data.title);
                    if (json_title !== sub_cat_data.name && !json_data.id.startsWith("dummy-")) {
                         logMessage(`[ê²½ê³ ] '${sub_cat_data.name}': JSON title ë¶ˆì¼ì¹˜ ('${json_title}'). ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.`);
                    }
                    jobs_to_process.push({ main_cat: main_cat_data, sub_cat: sub_cat_data, json_data: json_data });
                });

                logMessage("2. SQL ìƒì„± ì‘ì—… ì‹œì‘...");

                jobs_to_process.forEach(job => {
                    const { main_cat, sub_cat, json_data } = job;
                    logMessage(`\n--- ${main_cat.name} > ${sub_cat.name} SQL ìƒì„± ì¤‘ ---`);

                    if (!processed_main_cats.has(main_cat.id)) {
                        logMessage(`  > ë©”ì¸ ì¹´í…Œê³ ë¦¬ '${main_cat.name}' SQL ì¶”ê°€`);
                        main_cat_sql.push(`\nINSERT INTO consultation.categories (id, code, description, display_order, is_active, created_at, updated_at)\nVALUES (${main_cat.id}, '${main_cat.code}', '${main_cat.name}', 1, true, NOW(), NOW())\nON CONFLICT (id) DO NOTHING;`);

                        const name_tr = clean_text(main_cat.name);
                        const desc_text = `${main_cat.name} ê´€ë ¨ ë²•ë¥  ì„œë¹„ìŠ¤`;
                        const desc_tr = clean_text(desc_text);
                        main_cat_sql.push(`INSERT INTO consultation.category_translations (category_id, language, name, description, created_at, updated_at)\nVALUES (${main_cat.id}, '${selected_language}', '${name_tr}', '${desc_tr}', NOW(), NOW());`);

                        processed_main_cats.add(main_cat.id);
                    }

                    if (!processed_sub_cats.has(sub_cat.id)) {
                        logMessage(`  > ì„œë¸Œ ì¹´í…Œê³ ë¦¬ '${sub_cat.name}' SQL ì¶”ê°€`);
                        sub_cat_sql.push(`\nINSERT INTO consultation.sub_categories (id, category_id, code, description, display_order, is_active, created_at, updated_at)\nVALUES (${sub_cat.id}, ${main_cat.id}, '${sub_cat.code}', '${sub_cat.name}', 1, true, NOW(), NOW())\nON CONFLICT (id) DO NOTHING;`);

                        const name_tr = clean_text(sub_cat.name);
                        const desc_text = `${sub_cat.name} ê´€ë ¨ ë²•ë¥  ì„œë¹„ìŠ¤`;
                        const desc_tr = clean_text(desc_text);
                        sub_cat_sql.push(`INSERT INTO consultation.sub_category_translations (sub_category_id, language, name, description, created_at, updated_at)\nVALUES (${sub_cat.id}, '${selected_language}', '${name_tr}', '${desc_tr}', NOW(), NOW());`);

                        processed_sub_cats.add(sub_cat.id);
                    }

                    logMessage(`  > '${sub_cat.name}'ì˜ ì‚¬ì „ ì§ˆë¬¸ SQL ìƒì„±...`);
                    const question_sql_commands = parse_typeform_to_sql(json_data, sub_cat);
                    pre_question_sql.push(...question_sql_commands);
                });

                logMessage("3. SQL íŒŒì¼ ì·¨í•© ì¤‘...");

                let final_sql = main_cat_sql.join("\n") + "\n\n" +
                                sub_cat_sql.join("\n") + "\n\n" +
                                pre_question_sql.join("\n");

                generatedSqlContent = final_sql;

                logMessage("ì„±ê³µ! SQL ìƒì„± ì™„ë£Œ.");
                downloadSqlButton.disabled = false;

                // ìƒì„±ëœ SQL ë¯¸ë¦¬ë³´ê¸°
                showGeneratedSqlModal(generatedSqlContent);


            } catch (e) {
                has_error = true;
                logMessage(`[ì¹˜ëª…ì  ì˜¤ë¥˜] ${e.message}`);
                alert(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
            } finally {
                generateSqlButton.disabled = false;
                generateSqlButton.textContent = has_error ? "ğŸš€ ì˜¤ë¥˜ (ë‹¤ì‹œ ì‹œë„)" : "ğŸš€ SQL ìƒì„±í•˜ê¸°";
            }
        }

        /**
         * ìƒì„±ëœ SQLì„ ëª¨ë‹¬ë¡œ ë³´ì—¬ì£¼ê¸°
         * @param {string} sqlContent
         */
        function showGeneratedSqlModal(sqlContent) {
            modalTitle.textContent = "ìƒì„±ëœ SQL ìŠ¤í¬ë¦½íŠ¸";
            modalBody.innerHTML = `<textarea readonly>${sqlContent}</textarea>`;
            modal.style.display = "block";
        }

        /**
         * "SQL ë‹¤ìš´ë¡œë“œ" í•¸ë“¤ëŸ¬
         */
        function handleDownloadSql() {
            if (!generatedSqlContent) {
                logMessage("[ì˜¤ë¥˜] ë‹¤ìš´ë¡œë“œí•  SQL ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € SQLì„ ìƒì„±í•˜ì„¸ìš”.");
                alert("ë‹¤ìš´ë¡œë“œí•  SQL ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € SQLì„ ìƒì„±í•˜ì„¸ìš”.");
                return;
            }

            try {
                const blob = new Blob([generatedSqlContent], { type: 'text/sql;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'generated_sql_script.sql';
                document.body.appendChild(a);
                a.click();

                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                logMessage("SQL íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘.");
            } catch (e) {
                logMessage(`[ì˜¤ë¥˜] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
                alert(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
            }
        }

        // --- 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”© ---
        document.addEventListener('DOMContentLoaded', initialize);

        // í´ë¦­ ì´ë²¤íŠ¸ ìœ„ì„
        categoryListDiv.addEventListener('click', handleCategoryClick);

        // íŒŒì¼ í”¼ì»¤ ì´ë²¤íŠ¸
        filePicker.addEventListener('change', handleFileSelect);

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        toggleAllCheckboxesButton.addEventListener('click', handleToggleAllCheckboxes);
        generateSqlButton.addEventListener('click', handleGenerateSql);
        downloadSqlButton.addEventListener('click', handleDownloadSql);

        // ëª¨ë‹¬ ì´ë²¤íŠ¸
        showSchemaButton.addEventListener('click', showSchemaModal);
        modalClose.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                closeModal();
            }
        });

    </script>
</body>
</html>
