<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚖️ AI 법률 상담 SQL 생성기</title>
    <style>
        /* 기본 스타일 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1.5rem;
            background-color: #f8f9fa;
            color: #212529;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            display: flex;
            flex: 1;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        h1, h2 {
            margin-top: 0;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        h1 { font-size: 2rem; }
        h2 { font-size: 1.5rem; }

        /* 레이아웃 */
        .panel {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #left-panel {
            flex: 3;
            min-width: 400px;
        }
        #right-panel {
            flex: 2;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        #bottom-panel {
            width: 100%;
            margin-top: 1.5rem;
        }

        /* 컨트롤 */
        button, input[type="file"]::file-selector-button {
            font-size: 0.9rem;
            padding: 0.5rem 0.8rem;
            border: 1px solid #0d6efd;
            border-radius: 5px;
            background-color: #0d6efd;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        button:hover, input[type="file"]::file-selector-button:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        button:disabled {
            background-color: #adb5bd;
            border-color: #adb5bd;
            cursor: not-allowed;
        }
        button.secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #5c636a;
            border-color: #565e64;
        }
        button.outline {
            background-color: white;
            color: #0d6efd;
        }
        button.outline:hover {
            background-color: #f8f9fa;
        }

        /* 카테고리 리스트 */
        .category-group {
            border: 1px solid #e9ecef;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        .category-group-header {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .category-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f5;
        }
        .category-item:last-child { border-bottom: none; }
        .category-item input[type="checkbox"] {
            width: 1.15rem;
            height: 1.15rem;
        }
        .category-item-label {
            width: 150px;
            font-weight: 500;
        }
        .file-status {
            flex: 1;
            font-size: 0.9rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-status.loaded {
            color: #d63384;
            font-weight: 600;
            border-style: solid;
            border-color: #e6a9c7;
            background-color: #fdf3f8;
        }

        /* 파일 입력 숨기기 */
        input[type="file"] {
            display: none;
        }

        /* 로그 */
        #log-output {
            flex: 1;
            width: 100%;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.85rem;
            color: #343a40;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 0.5rem;
            box-sizing: border-box;
            background-color: #f8f9fa;
            min-height: 200px;
        }

        /* 모달 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            animation: slideIn 0.3s;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .modal-body {
            padding-top: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-body pre, .modal-body textarea {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 60vh;
            overflow-y: auto;
        }
        .modal-body textarea {
            width: 100%;
            box-sizing: border-box;
            min-height: 60vh;
            resize: vertical;
        }
        .close-button {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: black;
        }

        /* 트리 뷰 */
        .tree-view details {
            margin-left: 20px;
            border-left: 1px dashed #adb5bd;
            margin-top: 5px;
        }
        .tree-view summary {
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            background-color: #f1f3f5;
            font-weight: bold;
        }
        .tree-view summary:hover { background-color: #e9ecef; }
        .tree-view .answer {
            margin-left: 15px;
            padding: 5px;
        }
        .tree-view .answer code {
            font-weight: bold;
            color: #0b5ed7;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

    </style>
</head>
<body>

    <header>
        <h1>⚖️ AI 법률 상담 SQL 생성기 (Web Ver.)</h1>
    </header>

    <main>
        <div id="left-panel" class="panel">
            <h2>1. 카테고리 및 JSON 파일 선택</h2>

            <div style="background-color: #fff3cd; border: 1px solid #ffe69c; color: #664d03; padding: 1rem; border-radius: 5px; margin-bottom: 1.5rem;">
                <strong>참고:</strong> 웹 버전은 백엔드 서버 없이 동작하므로,
                <a href="https://developer.mozilla.org/ko/docs/Web/HTTP/CORS" target="_blank">CORS 정책</a>
                제한으로 인해 번역 기능을 지원하지 않습니다. SQL은 기본 언어('ko')로만 생성됩니다.
            </div>

            <div>
                <button id="toggle-all-checkboxes">전체 선택/해제</button>
                <button id="show-schema-button" class="secondary outline" style="float: right;">📜 스키마 보기</button>
            </div>

            <div id="category-list" style="margin-top: 1rem;">
                </div>
        </div>

        <div id="right-panel" class="panel">
            <h2>2. 처리 로그</h2>
            <textarea id="log-output" readonly></textarea>
        </div>
    </main>

    <footer id="bottom-panel" class="panel">
        <h2>3. SQL 생성 및 다운로드</h2>
        <button id="generate-sql-button" style="width: 200px; height: 50px; font-size: 1.2rem;">🚀 SQL 생성하기</button>
        <button id="download-sql-button" class="secondary" style="width: 200px; height: 50px; font-size: 1.2rem;" disabled>📄 SQL 다운로드</button>
    </footer>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">모달 제목</h2>
                <span id="modal-close" class="close-button">&times;</span>
            </div>
            <div id="modal-body" class="modal-body">
                </div>
        </div>
    </div>

    <input type="file" id="file-picker" accept=".json">


    <script>
        // --- 0. 상수 정의 (default_values.py + schema.sql) ---
        // 'default_values.py'의 CATEGORIES를 JS 객체로 변환
        const CATEGORIES = {
            '1': {'id': 100, 'code': 'INSURANCE', 'name': '보험금', 'subs': {
                '1': {'id': 101, 'code': 'INS_SUICIDE', 'name': '자살보험금'}, '2': {'id': 102, 'code': 'INS_ACCIDENT_DEATH', 'name': '상해사망보험금'},
                '3': {'id': 103, 'code': 'INS_DISPUTE', 'name': '보험금분쟁'}, '4': {'id': 104, 'code': 'INS_FRAUD', 'name': '보험사기'},
                '5': {'id': 105, 'code': 'INS_FIRE', 'name': '화재보험'}, }},
            '2': {'id': 200, 'code': 'TRAFFIC_ACCIDENT', 'name': '교통사고', 'subs': {
                '1': {'id': 201, 'code': 'TRF_DRIVER_INS', 'name': '운전자보험'}, '2': {'id': 202, 'code': 'TRF_12_NEGLIGENCE', 'name': '12대 중과실'},
                '3': {'id': 203, 'code': 'TRF_INJURY', 'name': '업무상과실치상'}, '4': {'id': 204, 'code': 'TRF_MOTORCYCLE', 'name': '이륜차사고'}, }},
            '3': {'id': 300, 'code': 'CRIMINAL', 'name': '형사', 'subs': {
                '1': {'id': 301, 'code': 'CRM_ASSAULT', 'name': '폭행/상해'}, '2': {'id': 302, 'code': 'CRM_COMM_OBSCENITY', 'name': '통매음'},
                '3': {'id': 303, 'code': 'CRM_FRAUD', 'name': '사기'}, '4': {'id': 304, 'code': 'CRM_DEFAMATION', 'name': '모욕/명예훼손'},
                '5': {'id': 305, 'code': 'CRM_SEXUAL', 'name': '성범죄'}, }}
        };

        // 'default_values.py'의 SUPPORTED_LANGUAGES (참고용)
        const SUPPORTED_LANGUAGES = {
            "ko": "한국어", "en": "영어", "zh": "중국어", "es": "스페인어", "ja": "일본어",
            "vi": "베트남어", "th": "태국어", "ms": "말레이어", "id": "인도네시아어", "fil": "필리핀어", "ru": "러시아어"
        };

        const BASE_LANGUAGE = 'ko';
        const END_OF_QUESTION_CODE = 'END';

        // 'schema.sql' 또는 'default_values.py'의 DEFAULT_SCHEMA_SQL
        const DEFAULT_SCHEMA_SQL = `
CREATE SCHEMA IF NOT EXISTS consultation;

-- 1. 메인 카테고리
CREATE TABLE consultation.categories (
    id INT PRIMARY KEY,
    code VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 1-1. 메인 카테고리 다국어
CREATE TABLE consultation.category_translations (
    id SERIAL PRIMARY KEY,
    category_id INT NOT NULL REFERENCES consultation.categories(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (category_id, language)
);

-- 2. 서브 카테고리
CREATE TABLE consultation.sub_categories (
    id INT PRIMARY KEY,
    category_id INT NOT NULL REFERENCES consultation.categories(id) ON DELETE CASCADE,
    code VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2-1. 서브 카테고리 다국어
CREATE TABLE consultation.sub_category_translations (
    id SERIAL PRIMARY KEY,
    sub_category_id INT NOT NULL REFERENCES consultation.sub_categories(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (sub_category_id, language)
);

-- 3. 사전 질문
CREATE TABLE consultation.pre_questions (
    id SERIAL PRIMARY KEY,
    sub_category_id INT NOT NULL REFERENCES consultation.sub_categories(id) ON DELETE CASCADE,
    code VARCHAR(100) UNIQUE NOT NULL, -- 'SQ001'과 같은 코드
    description TEXT,
    step INT NOT NULL,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3-1. 사전 질문 다국어
CREATE TABLE consultation.pre_question_translations (
    id SERIAL PRIMARY KEY,
    pre_question_id INT NOT NULL REFERENCES consultation.pre_questions(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    question_text TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (pre_question_id, language)
);

-- 4. 사전 질문 선택지
CREATE TABLE consultation.pre_question_options (
    id SERIAL PRIMARY KEY,
    pre_question_id INT NOT NULL REFERENCES consultation.pre_questions(id) ON DELETE CASCADE,
    code VARCHAR(100) UNIQUE NOT NULL, -- 'SQ001_O001'과 같은 코드
    next_question_code VARCHAR(100), -- 분기 로직
    description TEXT,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4-1. 사전 질문 선택지 다국어
CREATE TABLE consultation.pre_question_option_translations (
    id SERIAL PRIMARY KEY,
    pre_question_option_id INT NOT NULL REFERENCES consultation.pre_question_options(id) ON DELETE CASCADE,
    language VARCHAR(10) NOT NULL,
    option_text VARCHAR(255) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (pre_question_option_id, language)
);
        `.trim();

        // --- 1. 전역 상태 변수 ---
        /** @type {Object<string, {file: File, data: Object}>} */
        let loadedFiles = {};
        /** @type {string|null} */
        let generatedSqlContent = null;
        /** @type {HTMLInputElement} */
        let currentFilePickerSubCatId = null;

        // --- 2. DOM 참조 ---
        const categoryListDiv = document.getElementById('category-list');
        const logOutput = document.getElementById('log-output');
        const generateSqlButton = document.getElementById('generate-sql-button');
        const downloadSqlButton = document.getElementById('download-sql-button');
        const toggleAllCheckboxesButton = document.getElementById('toggle-all-checkboxes');

        // 파일 피커
        const filePicker = document.getElementById('file-picker');

        // 모달
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.getElementById('modal-close');
        const showSchemaButton = document.getElementById('show-schema-button');

        // --- 3. 헬퍼 함수 (Python 로직 이식) ---

        /**
         * 로그를 화면에 출력
         * @param {string} message
         */
        function logMessage(message) {
            console.log(message);
            logOutput.value += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight; // 자동 스크롤
        }

        /**
         * 텍스트를 정리 (SQL 인젝션 방지)
         * @param {string} text
         * @returns {string}
         */
        function clean_text(text) {
            if (!text) return "";
            return text.replace(/\n/g, ' ')
                       .replace(/\r/g, '')
                       .trim()
                       .replace(/'/g, "''"); // '를 ''로 이스케이프
        }

        /**
         * 더미 JSON 데이터 생성 (Python 'generate_dummy_json' 이식)
         * @param {string} sub_cat_name
         * @returns {Object}
         */
        function generate_dummy_json(sub_cat_name) {
            const dummy_indicator = "(더미 데이터 입니다)";
            logMessage(`[알림] 더미 데이터 생성: ${sub_cat_name}`);
            return {
                "id": `dummy-${sub_cat_name}`, "title": sub_cat_name,
                "fields": [
                    {"id": "q1_id", "ref": "q1_ref", "title": `[${sub_cat_name}] 사건의 피해자이십니까? ${dummy_indicator}`,
                    "properties": {"choices": [{"id": "q1_yes_id", "ref": "q1_yes_ref", "label": "예 (피해자)"}, {"id": "q1_no_id", "ref": "q1_no_ref", "label": "아니오 (가해자)"}]}},
                    {"id": "q2_victim_id", "ref": "q2_victim_ref", "title": `(피해자) 현재 증거 자료가 준비되셨나요? ${dummy_indicator}`,
                    "properties": {"choices": [{"id": "q2_yes_id", "ref": "q2_yes_ref", "label": "예"}, {"id": "q2_no_id", "ref": "q2_no_ref", "label": "아니오"}]}},
                    {"id": "q3_perp_id", "ref": "q3_perp_ref", "title": `(가해자) 혐의를 인정하십니까? ${dummy_indicator}`,
                    "properties": {"choices": [{"id": "q3_yes_id", "ref": "q3_yes_ref", "label": "예"}, {"id": "q3_no_id", "ref": "q3_no_ref", "label": "아니오"}]}}],
                "logic": [
                    {"ref": "q1_ref", "actions": [
                        {"condition": {"op": "is", "vars": [{}, {"type": "choice", "value": "q1_yes_ref"}]}, "details": {"to": {"type": "field", "value": "q2_victim_ref"}}},
                        {"condition": {"op": "is", "vars": [{}, {"type": "choice", "value": "q1_no_ref"}]}, "details": {"to": {"type": "field", "value": "q3_perp_ref"}}}]},
                    {"ref": "q2_victim_ref", "actions": [{"condition": {"op": "always", "vars": []}, "details": {"to": {"type": "thankyou", "value": "default_tys"}}}]},
                    {"ref": "q3_perp_ref", "actions": [{"condition": {"op": "always", "vars": []}, "details": {"to": {"type": "thankyou", "value": "default_tys"}}}]}]
            };
        }

        /**
         * JSON 데이터를 분석하여 트리 구조 생성 (Python 'build_tree_data' 이식)
         * @param {Object} json_data
         * @param {number} sub_cat_id
         * @returns {Object}
         */
        function build_tree_data(json_data, sub_cat_id) {
            const tree = {};
            const ref_to_q_code = {};
            const fields = json_data.fields || [];

            fields.forEach((field, i) => {
                const q_code = `${sub_cat_id}_Q${String(i + 1).padStart(3, '0')}`;
                ref_to_q_code[field.ref] = q_code;
            });

            const logic_map = {};
            (json_data.logic || []).forEach(logic => {
                const current_q_ref = logic.ref;
                (logic.actions || []).forEach(action => {
                    let next_q_ref = action.details.to.value;
                    if (action.details.to.type === 'thankyou') next_q_ref = END_OF_QUESTION_CODE;
                    const condition = action.condition;
                    if (condition.op === 'is') {
                        logic_map[[current_q_ref, condition.vars[1].value]] = next_q_ref;
                    } else if (condition.op === 'always') {
                        logic_map[[current_q_ref, 'always']] = next_q_ref;
                    }
                });
            });

            fields.forEach((field, i) => {
                const q_ref = field.ref;
                const q_code = ref_to_q_code[q_ref];
                const q_text = clean_text(field.title);
                const answers_data = [];
                const choices = (field.properties || {}).choices || [];

                if (choices.length === 0) {
                    const next_q_ref = logic_map[[q_ref, 'always']];
                    const next_q = (next_q_ref === END_OF_QUESTION_CODE) ? END_OF_QUESTION_CODE : (ref_to_q_code[next_q_ref] || "???");
                    answers_data.push({"text": "(주관식 답변)", "next_q": next_q});
                } else {
                    choices.forEach(choice => {
                        const c_ref = choice.ref;
                        const c_text = clean_text(choice.label);
                        let next_q_ref = logic_map[[q_ref, c_ref]];
                        if (!next_q_ref) next_q_ref = logic_map[[q_ref, 'always']];
                        const next_q = (next_q_ref === END_OF_QUESTION_CODE) ? END_OF_QUESTION_CODE : (ref_to_q_code[next_q_ref] || "???");
                        answers_data.push({"text": c_text, "next_q": next_q});
                    });
                }
                tree[q_code] = {"text": q_text, "answers": answers_data, "ref": q_ref};
            });
            return { tree_data: tree, ref_map: ref_to_q_code };
        }

        /**
         * 트리 구조를 HTML로 렌더링 (Python 'build_tree_view_controls' 이식)
         * @param {Object} tree_data
         * @param {string} start_question_ref
         * @param {Object} ref_to_q_code
         * @returns {string}
         */
        function build_tree_view_html(tree_data, start_question_ref, ref_to_q_code) {
            if (!tree_data || !start_question_ref) {
                return `<p style="color: red;">표시할 질문 데이터가 없습니다.</p>`;
            }
            const start_q_code = ref_to_q_code[start_question_ref];
            if (!start_q_code) {
                return `<p style="color: red;">시작 질문을 찾을 수 없습니다.</p>`;
            }

            let html = '<div class="tree-view">';
            const panels_dict = {};

            for (const [q_code, question] of Object.entries(tree_data)) {
                let answers_html = '';
                question.answers.forEach(answer => {
                    const next_q_str = (answer.next_q !== END_OF_QUESTION_CODE) ? `➡️ <code>${answer.next_q}</code>` : "➡️ <code>종료</code>";
                    answers_html += `<div class="answer"><i>${answer.text}</i> ${next_q_str}</div>`;
                });
                panels_dict[q_code] = `
                    <details>
                        <summary>[${q_code}] ${question.text}</summary>
                        ${answers_html}
                    </details>
                `;
            }

            const processed_codes = new Set();
            const queue = [start_q_code];
            while (queue.length > 0) {
                const current_code = queue.shift();
                if (!panels_dict[current_code] || processed_codes.has(current_code)) continue;

                html += panels_dict[current_code];
                processed_codes.add(current_code);

                const question = tree_data[current_code];
                question.answers.forEach(answer => {
                    const next_q = answer.next_q;
                    if (next_q !== END_OF_QUESTION_CODE && next_q !== "???" && !processed_codes.has(next_q)) {
                        if (!queue.includes(next_q)) queue.push(next_q);
                    }
                });
            }

            html += '</div>';
            return html;
        }

        /**
         * Typeform JSON을 SQL로 파싱 (Python 'parse_typeform_to_sql' 이식)
         * @param {Object} json_data
         * @param {Object} sub_cat
         * @returns {string[]}
         */
        function parse_typeform_to_sql(json_data, sub_cat) {
            const sql_commands = [];
            try {
                logMessage(`  > 3. 분기 로직(Logic) 파싱 중...`);
                const logic_map = {};
                (json_data.logic || []).forEach(logic => {
                    const current_q_ref = logic.ref;
                    (logic.actions || []).forEach(action => {
                        let next_q_ref = action.details.to.value;
                        if (action.details.to.type === 'thankyou') next_q_ref = END_OF_QUESTION_CODE;

                        const condition = action.condition;
                        if (condition.op === 'is') {
                            logic_map[[current_q_ref, condition.vars[1].value]] = next_q_ref;
                        } else if (condition.op === 'always') {
                            logic_map[[current_q_ref, 'always']] = next_q_ref;
                        }
                    });
                });

                logMessage(`  > 4. 질문/답변 코드 매핑 중...`);
                const ref_to_q_code = {};
                const ref_to_opt_code = {};
                const sub_cat_prefix = sub_cat.id;
                const fields = json_data.fields || [];

                fields.forEach((field, i) => {
                    const q_code = `${sub_cat_prefix}_Q${String(i + 1).padStart(3, '0')}`;
                    ref_to_q_code[field.ref] = q_code;

                    ((field.properties || {}).choices || []).forEach((choice, j) => {
                        const opt_code = `${q_code}_O${String(j + 1).padStart(3, '0')}`;
                        ref_to_opt_code[choice.ref] = opt_code;
                    });
                });

                logMessage(`  > 5. 사전 질문(Pre Questions) SQL 생성 시작...`);
                fields.forEach((field, i) => {
                    const field_ref = field.ref;
                    const q_code = ref_to_q_code[field_ref];
                    const q_title_ko = clean_text(field.title);
                    const step = i + 1;
                    logMessage(`    > 질문 ${step} (${q_code}): ${q_title_ko} 생성 중`);

                    sql_commands.push(`\n-- 질문 ${step}: ${q_title_ko} (Code: ${q_code}) --`);
                    sql_commands.push(
                        `INSERT INTO consultation.pre_questions (sub_category_id, code, description, step, display_order, is_active, created_at, updated_at)\n` +
                        `VALUES (${sub_cat.id}, '${q_code}', '${q_title_ko}', ${step}, ${i+1}, true, NOW(), NOW());`
                    );

                    // 번역 로직 제거 - 기본 언어('ko')만 추가
                    sql_commands.push(
                        `INSERT INTO consultation.pre_question_translations (pre_question_id, language, question_text, created_at, updated_at)\n` +
                        `VALUES ((SELECT id FROM consultation.pre_questions WHERE code = '${q_code}'), '${BASE_LANGUAGE}', '${q_title_ko}', NOW(), NOW());`
                    );

                    const choices = (field.properties || {}).choices || [];
                    if (choices.length === 0) {
                        // 주관식 (선택지 없음)
                        const next_q_ref = logic_map[[field_ref, 'always']];
                        let next_q_code_sql = "null";
                        if (next_q_ref === END_OF_QUESTION_CODE) {
                            next_q_code_sql = `'${END_OF_QUESTION_CODE}'`;
                        } else if (next_q_ref) {
                            next_q_code_sql = `'${ref_to_q_code[next_q_ref] || ''}'`;
                        }

                        const opt_code = `${q_code}_O001`;
                        sql_commands.push(
                            `INSERT INTO consultation.pre_question_options (pre_question_id, code, description, display_order, is_active, next_question_code, created_at, updated_at)\n` +
                            `VALUES ((SELECT id FROM consultation.pre_questions WHERE code = '${q_code}'), '${opt_code}', '주관식 답변', 1, true, ${next_q_code_sql}, NOW(), NOW());`
                        );

                        // 기본 언어('ko') 번역 추가
                        sql_commands.push(
                            `INSERT INTO consultation.pre_question_option_translations (pre_question_option_id, language, option_text, created_at, updated_at)\n` +
                            `VALUES ((SELECT id FROM consultation.pre_question_options WHERE code = '${opt_code}'), '${BASE_LANGUAGE}', '다음', NOW(), NOW());`
                        );

                    } else {
                        // 객관식 (선택지 있음)
                        choices.forEach((choice, j) => {
                            const choice_ref = choice.ref;
                            const opt_code = ref_to_opt_code[choice_ref];
                            const opt_label_ko = clean_text(choice.label);

                            let next_q_ref = logic_map[[field_ref, choice_ref]];
                            if (!next_q_ref) next_q_ref = logic_map[[field_ref, 'always']];

                            let next_q_code_sql = "null";
                            if (next_q_ref === END_OF_QUESTION_CODE) {
                                next_q_code_sql = `'${END_OF_QUESTION_CODE}'`;
                            } else if (next_q_ref) {
                                next_q_code_sql = `'${ref_to_q_code[next_q_ref] || ''}'`;
                            }

                            sql_commands.push(
                                `INSERT INTO consultation.pre_question_options (pre_question_id, code, description, display_order, is_active, next_question_code, created_at, updated_at)\n` +
                                `VALUES ((SELECT id FROM consultation.pre_questions WHERE code = '${q_code}'), '${opt_code}', '${opt_label_ko}', ${j+1}, true, ${next_q_code_sql}, NOW(), NOW());`
                            );

                            // 기본 언어('ko') 번역 추가
                            sql_commands.push(
                                `INSERT INTO consultation.pre_question_option_translations (pre_question_option_id, language, option_text, created_at, updated_at)\n` +
                                `VALUES ((SELECT id FROM consultation.pre_question_options WHERE code = '${opt_code}'), '${BASE_LANGUAGE}', '${opt_label_ko}', NOW(), NOW());`
                            );
                        });
                    }
                });

                logMessage(`  > 6. 모든 SQL 커맨드 생성 완료.`);
                return sql_commands;

            } catch (e) {
                const error_msg = `SQL 파싱 중 오류: ${e.message} (at ${e.stack.split('\n')[1].trim()})`;
                logMessage(`[오류] ${error_msg}`);
                throw new Error(error_msg);
            }
        }

        // --- 4. 메인 로직 (이벤트 핸들러) ---

        /**
         * 애플리케이션 초기화: 카테고리 목록 생성
         */
        function initialize() {
            logMessage("애플리케이션 초기화 중...");
            let html = "";
            for (const [main_key, main_cat] of Object.entries(CATEGORIES)) {
                html += `<div class="category-group">`;
                html += `<div class="category-group-header">${main_cat.name}</div>`;

                for (const [sub_key, sub_cat] of Object.entries(main_cat.subs)) {
                    const sub_cat_id = sub_cat.id;
                    html += `
                        <div class="category-item" data-sub-cat-id="${sub_cat_id}">
                            <input type="checkbox" id="chk-${sub_cat_id}" data-sub-cat-id="${sub_cat_id}">
                            <label for="chk-${sub_cat_id}" class="category-item-label">${sub_cat.name}</label>

                            <span class="file-status" id="status-${sub_cat_id}">선택된 JSON 파일 없음...</span>

                            <button class="view-structure-button outline" data-sub-cat-id="${sub_cat_id}" data-sub-cat-name="${sub_cat.name}">구조 보기</button>
                            <button class="load-file-button" data-sub-cat-id="${sub_cat_id}">JSON 로드</button>
                        </div>
                    `;
                }
                html += `</div>`;
            }
            categoryListDiv.innerHTML = html;
            logMessage("카테고리 목록 로드 완료.");
        }

        /**
         * 파일 선택 핸들러 (이벤트 위임)
         * @param {Event} e
         */
        function handleCategoryClick(e) {
            const target = e.target;

            // "JSON 로드" 버튼 클릭
            if (target.classList.contains('load-file-button')) {
                const subCatId = target.dataset.subCatId;
                currentFilePickerSubCatId = subCatId; // 현재 작업중인 ID 저장
                filePicker.click(); // 숨겨진 파일 입력 클릭
            }

            // "구조 보기" 버튼 클릭
            if (target.classList.contains('view-structure-button')) {
                const subCatId = target.dataset.subCatId;
                const subCatName = target.dataset.subCatName;
                showTreeModal(subCatId, subCatName);
            }
        }

        /**
         * 실제 파일이 선택되었을 때의 핸들러
         * @param {Event} e
         */
        function handleFileSelect(e) {
            if (!currentFilePickerSubCatId || e.target.files.length === 0) {
                logMessage("파일 선택 취소됨.");
                currentFilePickerSubCatId = null;
                return;
            }

            const file = e.target.files[0];
            const subCatId = currentFilePickerSubCatId;
            currentFilePickerSubCatId = null; // 리셋

            if (!file.type.includes('json')) {
                logMessage(`[오류] '${file.name}'은(는) JSON 파일이 아닙니다.`);
                alert("JSON 파일만 업로드할 수 있습니다.");
                return;
            }

            const reader = new FileReader();

            reader.onload = (event) => {
                try {
                    const json_data = JSON.parse(event.target.result);
                    loadedFiles[subCatId] = { file: file, data: json_data };

                    // UI 업데이트
                    const statusSpan = document.getElementById(`status-${subCatId}`);
                    statusSpan.textContent = `✅ ${file.name}`;
                    statusSpan.title = file.name;
                    statusSpan.classList.add('loaded');

                    logMessage(`파일 로드 성공 (${subCatId}): ${file.name}`);
                } catch (err) {
                    logMessage(`[오류] '${file.name}' 파일 파싱 실패: ${err.message}`);
                    alert(`파일 파싱 오류: ${err.message}`);
                }
            };

            reader.onerror = () => {
                logMessage(`[오류] '${file.name}' 파일 읽기 실패.`);
                alert("파일을 읽는 중 오류가 발생했습니다.");
            };

            reader.readAsText(file, 'UTF-8');

            // 동일한 파일을 다시 선택할 수 있도록 value를 리셋
            e.target.value = null;
        }

        /**
         * "전체 선택/해제" 핸들러
         */
        function handleToggleAllCheckboxes() {
            const checkboxes = categoryListDiv.querySelectorAll('input[type="checkbox"]');
            // 첫 번째 체크박스 기준으로 전체 상태 결정
            const isChecked = checkboxes.length > 0 ? !checkboxes[0].checked : false;
            checkboxes.forEach(chk => chk.checked = isChecked);
            logMessage(isChecked ? "모든 항목 선택됨." : "모든 항목 해제됨.");
        }

        /**
         * "스키마 보기" 핸들러
         */
        function showSchemaModal() {
            modalTitle.textContent = "데이터베이스 스키마 (schema.sql)";
            modalBody.innerHTML = `<textarea readonly>${DEFAULT_SCHEMA_SQL}</textarea>`;
            modal.style.display = "block";
        }

        /**
         * "구조 보기" 핸들러
         * @param {string} subCatId
         * @param {string} subCatName
         */
        function showTreeModal(subCatId, subCatName) {
            logMessage(`'${subCatName}'의 구조 보기 로딩 중...`);
            let json_data = null;
            let html_content = "";

            if (loadedFiles[subCatId]) {
                json_data = loadedFiles[subCatId].data;
                logMessage(` > 로드된 '${loadedFiles[subCatId].file.name}' 파일 사용.`);
            } else {
                json_data = generate_dummy_json(subCatName);
                logMessage(` > 로드된 파일 없음. 더미 데이터로 구조 생성.`);
            }

            if (!json_data || !json_data.fields || json_data.fields.length === 0) {
                 html_content = `<p style="color: red;">'${subCatName}'에 유효한 질문 데이터가 없습니다.</p>`;
                 logMessage(`[오류] '${subCatName}'에 유효한 질문 데이터가 없습니다.`);
            } else {
                try {
                    const { tree_data, ref_map } = build_tree_data(json_data, parseInt(subCatId));
                    const start_ref = json_data.fields[0].ref;
                    html_content = build_tree_view_html(tree_data, start_ref, ref_map);
                    logMessage(`'${subCatName}' 구조 데이터 생성 완료.`);
                } catch (build_err) {
                    html_content = `<p style="color: red;">트리 뷰 생성 실패:\n${build_err.message}</p>`;
                    logMessage(`[오류] '${subCatName}' 트리 뷰 생성 실패: ${build_err.message}`);
                }
            }

            modalTitle.textContent = `${subCatName} - 질문 구조`;
            modalBody.innerHTML = html_content;
            modal.style.display = "block";
        }

        /**
         * 모달 닫기
         */
        function closeModal() {
            modal.style.display = "none";
            modalBody.innerHTML = ""; // 내용 비우기
        }

        /**
         * "SQL 생성하기" 핸들러 (Python 'run_generation_thread' 이식)
         */
        function handleGenerateSql() {
            logMessage("SQL 생성을 시작합니다...");
            logOutput.value = "처리 로그:\n"; // 로그 초기화
            logMessage("SQL 생성을 시작합니다...");

            generateSqlButton.disabled = true;
            generateSqlButton.textContent = "생성 중...";
            downloadSqlButton.disabled = true;
            generatedSqlContent = null;

            let has_error = false;
            const processed_main_cats = new Set();
            const processed_sub_cats = new Set();

            const main_cat_sql = ["-- 📜 1. 메인 카테고리 (Main Category) --"];
            const sub_cat_sql = ["-- 📜 2. 서브 카테고리 (Sub Category) --"];
            const pre_question_sql = ["-- 📜 3. 사전 질문 (Pre Questions) --"];

            const selected_language = BASE_LANGUAGE; // 웹 버전은 'ko'만 지원

            try {
                const jobs_to_process = [];
                logMessage("1. 작업 목록 수집 중...");

                const checkboxes = categoryListDiv.querySelectorAll('input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                     logMessage("선택된 서브 카테고리가 없습니다.");
                     throw new Error("처리할 항목을 1개 이상 선택하세요.");
                }

                checkboxes.forEach(chk => {
                    const sub_cat_id = chk.dataset.subCatId;
                    // 부모-자식 관계 찾기
                    let main_cat_data = null;
                    let sub_cat_data = null;
                    for (const main_cat of Object.values(CATEGORIES)) {
                        for (const sub_cat of Object.values(main_cat.subs)) {
                            if (sub_cat.id == sub_cat_id) {
                                main_cat_data = main_cat;
                                sub_cat_data = sub_cat;
                                break;
                            }
                        }
                        if (sub_cat_data) break;
                    }

                    if (!main_cat_data || !sub_cat_data) {
                        logMessage(`[경고] ID ${sub_cat_id}에 해당하는 카테고리 정의를 찾을 수 없습니다. 건너뜁니다.`);
                        return;
                    }

                    let json_data = null;
                    if (loadedFiles[sub_cat_id]) {
                        json_data = loadedFiles[sub_cat_id].data;
                    } else {
                        logMessage(` > '${sub_cat_data.name}' 파일 없음. 더미 데이터로 대체합니다.`);
                        json_data = generate_dummy_json(sub_cat_data.name);
                    }

                    const json_title = clean_text(json_data.title);
                    if (json_title !== sub_cat_data.name && !json_data.id.startsWith("dummy-")) {
                         logMessage(`[경고] '${sub_cat_data.name}': JSON title 불일치 ('${json_title}'). 계속 진행합니다.`);
                    }
                    jobs_to_process.push({ main_cat: main_cat_data, sub_cat: sub_cat_data, json_data: json_data });
                });

                logMessage("2. SQL 생성 작업 시작...");

                jobs_to_process.forEach(job => {
                    const { main_cat, sub_cat, json_data } = job;
                    logMessage(`\n--- ${main_cat.name} > ${sub_cat.name} SQL 생성 중 ---`);

                    if (!processed_main_cats.has(main_cat.id)) {
                        logMessage(`  > 메인 카테고리 '${main_cat.name}' SQL 추가`);
                        main_cat_sql.push(`\nINSERT INTO consultation.categories (id, code, description, display_order, is_active, created_at, updated_at)\nVALUES (${main_cat.id}, '${main_cat.code}', '${main_cat.name}', 1, true, NOW(), NOW())\nON CONFLICT (id) DO NOTHING;`);

                        const name_tr = clean_text(main_cat.name);
                        const desc_text = `${main_cat.name} 관련 법률 서비스`;
                        const desc_tr = clean_text(desc_text);
                        main_cat_sql.push(`INSERT INTO consultation.category_translations (category_id, language, name, description, created_at, updated_at)\nVALUES (${main_cat.id}, '${selected_language}', '${name_tr}', '${desc_tr}', NOW(), NOW());`);

                        processed_main_cats.add(main_cat.id);
                    }

                    if (!processed_sub_cats.has(sub_cat.id)) {
                        logMessage(`  > 서브 카테고리 '${sub_cat.name}' SQL 추가`);
                        sub_cat_sql.push(`\nINSERT INTO consultation.sub_categories (id, category_id, code, description, display_order, is_active, created_at, updated_at)\nVALUES (${sub_cat.id}, ${main_cat.id}, '${sub_cat.code}', '${sub_cat.name}', 1, true, NOW(), NOW())\nON CONFLICT (id) DO NOTHING;`);

                        const name_tr = clean_text(sub_cat.name);
                        const desc_text = `${sub_cat.name} 관련 법률 서비스`;
                        const desc_tr = clean_text(desc_text);
                        sub_cat_sql.push(`INSERT INTO consultation.sub_category_translations (sub_category_id, language, name, description, created_at, updated_at)\nVALUES (${sub_cat.id}, '${selected_language}', '${name_tr}', '${desc_tr}', NOW(), NOW());`);

                        processed_sub_cats.add(sub_cat.id);
                    }

                    logMessage(`  > '${sub_cat.name}'의 사전 질문 SQL 생성...`);
                    const question_sql_commands = parse_typeform_to_sql(json_data, sub_cat);
                    pre_question_sql.push(...question_sql_commands);
                });

                logMessage("3. SQL 파일 취합 중...");

                let final_sql = main_cat_sql.join("\n") + "\n\n" +
                                sub_cat_sql.join("\n") + "\n\n" +
                                pre_question_sql.join("\n");

                generatedSqlContent = final_sql;

                logMessage("성공! SQL 생성 완료.");
                downloadSqlButton.disabled = false;

                // 생성된 SQL 미리보기
                showGeneratedSqlModal(generatedSqlContent);


            } catch (e) {
                has_error = true;
                logMessage(`[치명적 오류] ${e.message}`);
                alert(`오류 발생: ${e.message}`);
            } finally {
                generateSqlButton.disabled = false;
                generateSqlButton.textContent = has_error ? "🚀 오류 (다시 시도)" : "🚀 SQL 생성하기";
            }
        }

        /**
         * 생성된 SQL을 모달로 보여주기
         * @param {string} sqlContent
         */
        function showGeneratedSqlModal(sqlContent) {
            modalTitle.textContent = "생성된 SQL 스크립트";
            modalBody.innerHTML = `<textarea readonly>${sqlContent}</textarea>`;
            modal.style.display = "block";
        }

        /**
         * "SQL 다운로드" 핸들러
         */
        function handleDownloadSql() {
            if (!generatedSqlContent) {
                logMessage("[오류] 다운로드할 SQL 내용이 없습니다. 먼저 SQL을 생성하세요.");
                alert("다운로드할 SQL 내용이 없습니다. 먼저 SQL을 생성하세요.");
                return;
            }

            try {
                const blob = new Blob([generatedSqlContent], { type: 'text/sql;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'generated_sql_script.sql';
                document.body.appendChild(a);
                a.click();

                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                logMessage("SQL 파일 다운로드 시작.");
            } catch (e) {
                logMessage(`[오류] 파일 다운로드 실패: ${e.message}`);
                alert(`파일 다운로드 중 오류 발생: ${e.message}`);
            }
        }

        // --- 5. 이벤트 리스너 바인딩 ---
        document.addEventListener('DOMContentLoaded', initialize);

        // 클릭 이벤트 위임
        categoryListDiv.addEventListener('click', handleCategoryClick);

        // 파일 피커 이벤트
        filePicker.addEventListener('change', handleFileSelect);

        // 버튼 이벤트
        toggleAllCheckboxesButton.addEventListener('click', handleToggleAllCheckboxes);
        generateSqlButton.addEventListener('click', handleGenerateSql);
        downloadSqlButton.addEventListener('click', handleDownloadSql);

        // 모달 이벤트
        showSchemaButton.addEventListener('click', showSchemaModal);
        modalClose.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                closeModal();
            }
        });

    </script>
</body>
</html>
